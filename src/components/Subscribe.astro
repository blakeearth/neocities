---
import subscribeFormData from "../data/subscribe_form/subscribe_form.json";

const {
  heading,
  formActionUrl,
  nameFieldId,
  emailFieldId,
  namePlaceholder,
  emailPlaceholder,
  submitButtonText,
  successMessage,
  successDuration,
} = subscribeFormData;
---

<div class="w-full">
  <h3 class="mb-4 text-lg">{heading}</h3>
  <form id="google-form" class="flex flex-col gap-4">
    <div class="flex flex-col gap-1">
      <label for="name" class="font-semibold text-sm">Name</label>
      <input
        type="text"
        id="name"
        placeholder={namePlaceholder}
        required
        class="p-2 border border-[var(--border)] rounded font-[inherit] text-base bg-[var(--bg)] text-[var(--text)] focus:outline-[var(--link)] focus:outline-2 focus:outline-offset-2 disabled:opacity-60 disabled:cursor-not-allowed"
      />
    </div>
    <div class="flex flex-col gap-1">
      <label for="email" class="font-semibold text-sm">Email</label>
      <input
        type="email"
        id="email"
        placeholder={emailPlaceholder}
        required
        class="p-2 border border-[var(--border)] rounded font-[inherit] text-base bg-[var(--bg)] text-[var(--text)] focus:outline-[var(--link)] focus:outline-2 focus:outline-offset-2 disabled:opacity-60 disabled:cursor-not-allowed"
      />
    </div>
    <div class="flex gap-2 mt-2">
      <button
        type="submit"
        id="submit-btn"
        class="px-4 py-2 cursor-pointer border border-[var(--border)] bg-[var(--bg)] text-[var(--text)] font-semibold hover:bg-[var(--text)] hover:text-[var(--bg)] disabled:opacity-60 disabled:cursor-not-allowed text-[1rem]"
      >
        {submitButtonText}
      </button>
    </div>
  </form>
</div>

<script
  is:inline
  define:vars={{
    formActionUrl,
    nameFieldId,
    emailFieldId,
    submitButtonText,
    successMessage,
    successDuration,
  }}
>
  (function() {
    const form = document.getElementById("google-form");
    const submitBtn = document.getElementById("submit-btn");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");

    function setFormState(disabled, buttonText) {
      nameInput.disabled = disabled;
      emailInput.disabled = disabled;
      submitBtn.disabled = disabled;
      submitBtn.textContent = buttonText;
    }

    function submitToGoogleForm(name, email) {
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.name = "hidden_iframe";
      document.body.appendChild(iframe);

      const hiddenForm = document.createElement("form");
      hiddenForm.action = formActionUrl;
      hiddenForm.method = "POST";
      hiddenForm.target = "hidden_iframe";

      const fields = [
        { name: nameFieldId, value: name },
        { name: emailFieldId, value: email },
      ];

      fields.forEach(function(field) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = field.name;
        input.value = field.value;
        hiddenForm.appendChild(input);
      });

      document.body.appendChild(hiddenForm);
      hiddenForm.submit();

      setTimeout(function() {
        document.body.removeChild(iframe);
        document.body.removeChild(hiddenForm);
      }, 1000);
    }

    if (form) {
      form.addEventListener("submit", function(e) {
        e.preventDefault();

        const name = nameInput.value;
        const email = emailInput.value;

        setFormState(true, successMessage);
        submitToGoogleForm(name, email);

        setTimeout(function() {
          setFormState(false, submitButtonText);
          form.reset();
        }, successDuration);
      });
    }
  })();
</script>
