---
interface Props {
  title: string;
  pattern?: string;
  height?: string;
  mobileHeight?: string;
  border?: boolean;
  marginBottom?: string;
}

const {
  title = '',
  pattern,
  height = '300px',
  mobileHeight = '200px',
  border = true,
  marginBottom = '1rem'
} = Astro.props;

// Randomly select one of the three patterns at build time if not specified
const patterns = [
  'animated-pattern.svg',
  'animated-pattern-2.svg',
  'animated-pattern-3.svg'
];

const hash = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash);
};

const seed = title ? hash(title) : 0;
const selectedPattern = pattern || patterns[seed % patterns.length];
const headerId = `header-${Math.random().toString(36).substr(2, 9)}`;
---

{title && (
  <div id={headerId} class="animated-header" style={`height: ${height}; margin-bottom: ${marginBottom}; ${border ? '' : 'border: none;'}`}>
    <object
      data={`/${selectedPattern}`}
      type="image/svg+xml"
      aria-label={title}
      class="pattern-svg"
    >
      <img src={`/${selectedPattern}`} alt={title} />
    </object>
    <div class="header-title">{title}</div>
  </div>
)}

<style define:vars={{ mobileHeight }}>
  .animated-header {
    position: relative;
    width: 100%;
    overflow: hidden;
    border: 0.2vh solid var(--border);
  }

  .pattern-svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  .header-title {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Abril Fatface', Georgia, serif;
    color: #363636;
    text-align: center;
    margin: 0;
    z-index: 10;
    max-width: 90%;
    line-height: 1.2;
    white-space: pre-wrap;
    background: var(--bg);
    padding: 0.5rem 1rem;
    border: 0.2vh solid var(--border);
  }

  @media (max-width: 768px) {
    .animated-header {
      height: var(--mobileHeight) !important;
    }
  }
</style>

<script define:vars={{ headerId }}>
  const resizeText = () => {
    const container = document.getElementById(headerId);
    const textEl = container?.querySelector('.header-title');

    if (!container || !textEl) return;

    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;

    let fontSize = containerWidth * 0.15;
    textEl.style.fontSize = fontSize + 'px';

    const maxHeight = containerHeight * 0.4;

    while (textEl.scrollHeight > maxHeight && fontSize > 20) {
      fontSize -= 2;
      textEl.style.fontSize = fontSize + 'px';
    }
  };

  window.addEventListener('resize', resizeText);
  window.addEventListener('load', resizeText);
  resizeText();
</script>
